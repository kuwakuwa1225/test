<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>まにあ～る - ホーム</title>
  <!-- 省略：CSSはそのままでOK -->
</head>
<body>
  <header>
    <h1>まにあ～る 京都橘大学用</h1>
  </header>

  <nav>
    <!-- 省略：ナビゲーション -->
  </nav>

  <main role="main">
    <!-- 省略：サービス紹介など -->

    <section>
      <h2>時間割</h2>
      <!-- 時間割表はそのままでOK -->
      <table id="timetable" role="table">
        <!-- ...（略） -->
      </table>

      <!-- ✅ 追加：保存（上書き）ボタン -->
      <button type="button" id="sendBtn">LINEに送信</button>
      <button type="button" id="saveBtn">上書き保存</button>
    </section>
  </main>

  <footer>京都橘大学生作 まにあ～る</footer>

  <!-- ✅ Supabaseライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ✅ localStorageからログインID取得
    const user_id = localStorage.getItem("line_user_id");
    if (!user_id) {
      alert("LINEログインしていません。ログインページへ移動します。");
      window.location.href = "line_login.html";
    }

    // ✅ Supabase設定
    const supabaseUrl = 'https://mtmlxanzhctzufhraxhy.supabase.co';
    const supabaseKey = 'YOUR_SUPABASE_API_KEY';  // セキュリティ上、開発後は.envやSecretsに移す
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const periodTimeMap = {
      1: '09:00-10:40',
      2: '10:55-12:35',
      3: '13:20-15:00',
      4: '15:15-16:55',
      5: '17:10-18:50',
    };

    // ✅ データ追加処理（送信・保存共通）
    async function insertTimetableData() {
      const inputs = document.querySelectorAll('.subject-input');
      let successCount = 0;
      let failCount = 0;

      for (const input of inputs) {
        const name = input.value.trim();
        if (!name) continue;

        const day_of_week = input.dataset.day;
        const period = parseInt(input.dataset.period);
        const time = periodTimeMap[period] || '';
        const roomInput = document.querySelector(`input.classroom-input[data-day="${day_of_week}"][data-period="${period}"]`);
        const classroom = roomInput ? roomInput.value.trim() : '';

        const { error } = await supabase.from('subjects').insert({
          name,
          day_of_week,
          time,
          classroom,
          user_id,
        });

        if (error) {
          console.error('送信失敗:', error);
          failCount++;
        } else {
          successCount++;
        }
      }

      return { successCount, failCount };
    }

    // ✅ 上書き保存
    async function overwriteTimetable() {
      const { error: deleteError } = await supabase
        .from('subjects')
        .delete()
        .eq('user_id', user_id);

      if (deleteError) {
        alert('既存データの削除に失敗しました');
        console.error(deleteError);
        return;
      }

      const { successCount, failCount } = await insertTimetableData();
      alert(`保存完了\n成功: ${successCount}件\n失敗: ${failCount}件`);
    }

    // ✅ 送信ボタン
    async function sendTimetableToSupabase() {
      const { successCount, failCount } = await insertTimetableData();
      alert(`送信完了\n成功: ${successCount}件\n失敗: ${failCount}件`);
    }

    // ✅ ボタンイベント登録
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('sendBtn').addEventListener('click', sendTimetableToSupabase);
      document.getElementById('saveBtn').addEventListener('click', overwriteTimetable);
    });
  </script>
</body>
</html>
